<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Profile</title>
    <link rel="stylesheet" href="css/user_main.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-auth.js"></script>
    <script>
        // Firebase Configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBA2O5kze6cSrMqrUpDYoP5KZepBsNEa4k",
            authDomain: "library-management-syste-37dc2.firebaseapp.com",
            databaseURL: "https://library-management-syste-37dc2-default-rtdb.firebaseio.com",
            projectId: "library-management-syste-37dc2",
            storageBucket: "library-management-syste-37dc2.firebasestorage.app",
            messagingSenderId: "962676782645",
            appId: "1:962676782645:web:c008daf774bcee5a80e37c",
            measurementId: "G-NZ9VJF0LJ2"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Get the email from the URL query parameter and decode it
        const urlParams = new URLSearchParams(window.location.search);
        const email = decodeURIComponent(urlParams.get('rollNumber'));
        
        if (email) {
            console.log("Email passed: " + email);
            // Now use the email to fetch and update user data
            loadUserProfile(email);
        } else {
            console.error("No email found in the URL.");
            alert("No email found in the URL.");
        }

        // Function to load user profile based on email passed in URL
        function loadUserProfile(userEmail) {
            console.log("Loading profile for email: " + userEmail);
            db.collection("users")
                .doc(userEmail) // Query by email (using email as document ID)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('update-name').value = userData.name || '';
                        document.getElementById('update-roll-number').value = userData.email || ''; // Now using email as roll number
                        document.getElementById('update-dob').value = userData.DOB || '';
                    } else {
                        alert("No user data found for the current email.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching user details:", error);
                    alert("Failed to fetch user details.");
                });
        }

        // Update user details
        function updateUserDetails() {
            const newName = document.getElementById('update-name').value;
            const newEmail = document.getElementById('update-roll-number').value;  // Email is now used as roll number
            const newDOB = document.getElementById('update-dob').value;

            if (!newName || !newEmail || !newDOB) {
                alert("All fields are required!");
                return;
            }

            // Ensure the email exists in the URL (it is read-only in the form)
            const email = newEmail;  // You could also fetch it from the URL again if needed

            db.collection("users")
                .doc(email) // Use email as the document ID
                .update({
                    name: newName,
                    email: newEmail,
                    DOB: newDOB
                })
                .then(() => {
                    alert("Profile updated successfully!");
                    window.location.href = "user_main.html"; // Redirect back to user dashboard
                })
                .catch(error => {
                    console.error("Error updating profile:", error);
                    alert("Failed to update profile.");
                });
        }
    </script>
</head>
<body>
    <div class="main_container">
        <h1>Update Profile</h1>

        <form id="update-profile-form">
            <label for="update-name">Name:</label>
            <input type="text" id="update-name" placeholder="Enter your name" required><br>

            <!-- <label for="update-roll-number">Email:</label>
            <input type="text" id="update-roll-number" placeholder="Enter your email" required readonly><br> -->

            <label for="update-dob">Date of Birth:</label>
            <input type="date" id="update-dob" required><br>

            <button type="button" onclick="updateUserDetails()">Save Changes</button>
        </form>
        <br>
        <button onclick="window.location.href='user_main.html'">Back to Dashboard</button>
    </div>
</body>
</html>
